---
title: 'M2.951 - Tipologia i cicle de vida de les dades'
author: "Autors: Francisco J. Bastida López (fbastidal@uoc.edu) / Ivan Benaiges Trenchs (ibenaiges@uoc.edu)"
date: "Juny 2023"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
    includes:
      in_header: header.html
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*****

**Descripció de la Pràctica a realitzar**

L’objectiu d’aquesta activitat serà el tractament d’un dataset, que pot ser el creat a la pràctica 1 o bé qualsevol dataset lliure disponible a Kaggle (https://www.kaggle.com).

Un exemple de dataset amb el qual podeu treballar és el “Heart Attack Analysis & Prediction dataset” (https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-predictiondataset).

Important: si escolliu un dataset diferent al proposat és important que aquest contingui una àmplia varietat de dades numèriques i categòriques per poder fer una anàlisi més rica i poder respondre a les diferents preguntes plantejades a l’enunciat de la pràctica. Seguint les principals etapes d’un projecte analític, les diferents tasques a realitzar (i justificar) són les següents:

1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?
2. Integració i selecció de les dades d’interès a analitzar. Pot ser el resultat d’addicionar diferents datasets o una subselecció útil de les dades originals, en base a l’objectiu que es vulgui aconseguir.
3. Neteja de les dades.
    3.1. Les dades contenen zeros o elements buits? Gestiona cadascun d’aquests casos.
    3.2. Identifica i gestiona els valors extrems.
4. Anàlisi de les dades.
    4.1. Selecció dels grups de dades que es volen analitzar/comparar (p. e., si es volen comparar grups de dades, quins són aquests grups i quins tipus d’anàlisi s’aplicaran?).
    4.2. Comprovació de la normalitat i homogeneïtat de la variància.
    4.3. Aplicació de proves estadístiques per comparar els grups de dades. En funció de les dades i de l’objectiu de l’estudi, aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi diferents.
5. Representació dels resultats a partir de taules i gràfiques. Aquest apartat es pot respondre al llarg de la pràctica, sense la necessitat de concentrar totes les representacions en aquest punt de la pràctica.
6. Resolució del problema. A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?
7. Codi. Cal adjuntar el codi, preferiblement en R, amb el que s’ha realitzat la neteja, anàlisi i representació de les dades. Si ho preferiu, també podeu treballar en Python.
8. Vídeo. Realitzar un breu vídeo explicatiu de la pràctica (màxim 10 minuts) on tots els integrants de l'equip expliquin amb les seves pròpies paraules el desenvolupament de la pràctica, basant-se en les preguntes de l'enunciat per a justificar i explicar el codi desenvolupat. Aquest vídeo s'haurà de lliurar a través d'un enllaç al Google Drive de la UOC (https://drive.google.com/…), juntament amb l’enllaç al repositori Git lliurat.


*****

# Descripció del dataset

Inicialment s'havia pensat en aprofitar les dades recopilades durant la primera pràctica, relacionades amb dades de navegació de vaixells. No obstant, després de valorar-ho, no trobavem com poder utilitzar-lo de forma bastant gràfica i que ens permetés realitzar un estudi estadístic com el que es demana a l'enunciat, pel que finalment hem decidit utilitzar el conjunt de dades que es posa com a exemple a l'enunciat, ja que considerem que resulta molt interessant i pot donar més joc al estar relacionat amb temes de salut.

El conjunt de dades seleccionat proporciona informació sobre diferents factors que podrien estar relacionats amb malalties cardiovasculars, més concretament amb predir la probabilitat de patir un atac de cor.

Es tracta d'un conjunt de dades que ens permetrà realitzar un estudi en major profunditat de possibles problemes del cor, molt més centrat en els atacs de cor, al tenir una variable que està directament relacionada amb el resultat que es va obtenir durant l'estudi dels pacients i que ens ens permeti buscar un model que permeti determinar la probabilitat de patir un atac de cor per part de persones segons els valors dels diferents factors d'estudi.

Per poder facilitar aquest anàlisi, el dataset conté el fitxer *heart.csv* amb les següents variables/atributs:

* **age**: edat del pacient
* **sex**: gènere del pacient 
    * 0 = femení
    * 1 = masculí
* **cp**: tipus de dolor toràcic que experimenta el pacient
    * 0 = angina típica
    * 1 = angina atípica
    * 2 = dolor no relacionat amb angina
    * 3 = asimptomàtic (sense dolor toràcic))
* **trtbps**: pressió arterial en repòs (mm Hg)
* **chol**: nivell de colesterol (md/dl)
* **fbs**: nivell de sucre en sang en dejú
    * 0 = normal
    * 1 = alt)
* **restecg**: resultat de l'electrocardiograma en repòs
    * 0 = normal
    * 1 = anomalies en l'ona ST-T
    * 2 = hipertrofia ventricular esquerra probable o definitiva segons els criteris d'Estes
* **thalachh**: freqüència cardíaca màxima registrada pel pacient durant les proves realitzades
* **exng**: angina provocada per l'exercici
    * 0 = no
    * 1 = sí
* **oldpeak**: canvis en el segment ST de l'electrocardiograma després de l'exercici físic
* **slp**: patró de canvi en el segment ST de l'electrocardiograma durant una prova d'esforç o situacions d'estrès
    * 0 = pendent plana
    * 1 = pendent ascendent (canvi en el patró elèctric del cor)
    * 2 = pendent descendent (canvi en el patró elèctric del cor)
* **caa**: nombre de vasos sanguinis coronaris que mostren obstrucció o estenosi significativa
    * 0 = sense obstrucció detectada
    * 1 = obstrucció en un dels vasos sanguinis
    * 2 = obstrucció en dos dels vasos sanguinis
    * 3 = obstrucció en tres dels vasos sanguinis
    * 4 = obstrucció en els quatre vasos sanguinis
* **thall**: relacionat amb una malaltia hereditària de la sang anomenada talassèmia
    * 1 = no s'ha detectat cap indici
    * 2 = presència d'un defecte fix
    * 3 = presència d'un defecte reversible
* **output**: probabilitat de patir un atac de cor:
    * 0 = sense o poca probabilitat
    * 1 = major probabilitat

Per altra banda, el fitxer *o2Saturation.csv* conté el que sem,blen múltiples observacions relacionades amb el nivell de saturació d'oxigen, però no s'ha trobat una manera de relacionar-los directament amb el fitxer anterior, ja que solament conté moltíssimes més observacions (3586 en total) sense cap tipus d'idenfificador que ens permeti poder realitzar una integració de les dades d'ambdós fitxers per tenir un conjunt més complet.


# Integració i selecció de les dades d’interès a analitzar

Abans de començar, és necessari carregar el fitxer en un data frame que ens permeti treballar de forma còmode amb les dades a través del codi en R:

```{r 1_1_carrega_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# El joc de dades està conformat per un fitxer CSV, amb separació per comes i amb una capçalera, pel que carreguem el fitxer utilitzant la següent funció:
dfHeartAttack <- read.csv("..\\dataset\\heart.csv", header=TRUE)
```

Una vegada carregades totes les dades, procedim a un primer anàlisi ràpid a partir del resum estadístic del data frame:

```{r 1_2_estadistiques_basiques_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# Mostrem la informació bàsica del data frame per comprovar si s'han de realitzar canvis a simple vista:
str(dfHeartAttack)

# Mostrem també un resum estadístic de les variables/atributs que conformen el joc de dades:
summary(dfHeartAttack)
```

Veiem que tenim un joc de dades compost per un total de 303 observacions i 14 variables. Per altra banda, a simple vista no s'observen valors que puguin ser considerats com *outliers*, tot i que ho veurem amb major detall més endavant. Per altra banda, 

Per seleccionar aquelles variables que puguin estar més directament relacionades amb l'atac de cor, realitzem un primer anàlisi exploratori que ens permeti entendre millor el conjunt de dades:

```{r 1_3_grafic_distribucio_probabilitat_atac_cor_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem les llibreries necessàries per realitzar els diferents gràfics que anirem generant:
if (!require("ggplot2")) install.packages("ggplot2"); library("ggplot2")
if (!require("ggpubr")) install.packages("ggpubr"); library("ggpubr")
if (!require("grid")) install.packages("grid"); library("grid")
if (!require("gridExtra")) install.packages("gridExtra"); library("gridExtra")

# Visualitzem la quantitat d'observacions que s'han identificat amb una probabilitat més alta i més baixa que es van identificar en  referència als atacs de cor:
ggplot(dfHeartAttack,aes(factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
    geom_bar() +labs(x="Probabilitat", y="Pacients") + 
		guides(fill=guide_legend(title="")) + 
		scale_fill_manual(values=c("#008000","#800000")) + 
		ggtitle("Probabilitat d'atac de cor") +
    theme(axis.text.x = element_text(hjust = 1))

# Calculem la proporció per poder tenir una idea de com es reparteixen les observacions:
table(dfHeartAttack$output)/length(dfHeartAttack$output)
```

Veiem que les dades estan molt repartides entre els pacients que tenen una probabilitat major i menor de patir un atac de cor segons els factors registrats.

Creem uns quants gràfics que ens permetin veure la relació entre les variables i la probabilitat de patir un atac de cor:

```{r 1_4_grafics_distribuciovariables_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
plotbyAge <- ggplot(dfHeartAttack,aes(age, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Edat", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per edat") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbySex <- ggplot(dfHeartAttack,aes(factor(sex, levels = c(0, 1), labels = c("Femení", "Masculí")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Gènere", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per gènere") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyCP <- ggplot(dfHeartAttack,aes(factor(cp, levels = c(0, 1, 2, 3), labels = c("Angina típica", "Angina atípica", "No angina", "Assimptomàtic")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Tipus de dolor", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per dolor toràcic") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyExng <- ggplot(dfHeartAttack,aes(factor(exng, levels = c(0, 1), labels = c("No", "Sí")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Angina provocada per exercici", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per angina provocada per exercici") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyFBS <- ggplot(dfHeartAttack,aes(factor(fbs, levels = c(0, 1), labels = c("Normal", "Alt")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Nivell de sucre", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per nivell de sucre") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyTRTBPS <- ggplot(dfHeartAttack,aes(trtbps, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Pressió arterial", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per pressió arterial en repòs") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyChol <- ggplot(dfHeartAttack,aes(chol, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Colesterol", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per colesterol") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyRestecg <- ggplot(dfHeartAttack,aes(factor(restecg, levels = c(0, 1, 2), labels = c("Normal", "Anomalies", "Hipertròfia")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Electrocardiograma", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per resultat de l'electrocardiograma") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyOldpeak <- ggplot(dfHeartAttack,aes(oldpeak, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Canvis electrocardiograma", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per canvis en l'electrocardiograma") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbySLP <- ggplot(dfHeartAttack,aes(factor(slp, levels = c(0, 1, 2), labels = c("Plana", "Ascendent", "Descendent")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Pendent", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per patró de canvi") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyThalachh <- ggplot(dfHeartAttack,aes(thalachh, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Freqüència", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per freqüència màxima registrada") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyCAA <- ggplot(dfHeartAttack,aes(caa, fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Vasos", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per vasos sanguinis obstruïts") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

plotbyThall <- ggplot(dfHeartAttack,aes(factor(thall, levels = c(0, 1, 2, 3), labels = c("Unknown", "Sense", "Defecte fix", "Defecte reversible")), fill=factor(output, levels = c(0, 1), labels = c("Baixa", "Alta")))) + 
					geom_bar() +labs(x="Indicis", y="Pacients") + 
					guides(fill=guide_legend(title="")) + 
				  scale_fill_manual(values=c("#008000","#800000")) + 
					ggtitle("Probabilitat per talassèmia") +
          theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Mostrem els diferents gràfics de forma agrupada:
grid.newpage()
grid.arrange(plotbyAge, plotbySex, plotbyCP, plotbyExng, plotbyFBS, plotbyTRTBPS, plotbyChol, plotbyRestecg, plotbyOldpeak, ncol=3)

grid.newpage()
grid.arrange(plotbySLP, plotbyThalachh, plotbyCAA, plotbyThall, ncol=2)
```

Observant els diversos factors que es troben dins el conjunt de dades, sembla que la variància entre els diferents valors i la seva relació amb la probabilitat de patir un atac de cor podria ser interessant mantenir tots els atributs que tenim per poder utilitzar-los durant la resta de l'anàlisi.


# Neteja de les dades

## Valors nul·ls

Comprobem si existeixen valors nul·ls en les dades, tot i que, aparentment, al revisar els resultats del resum estadístic anterior sembla que no existeixi cap valor d'aquest tipus:

```{r 2_1_valors_null_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# Revisem el total de valors NA i blancs que hi ha a cada variable:
colSums(is.na(dfHeartAttack))
colSums(dfHeartAttack == "")
```

Es confirma que no existeixen valors d'aquest tipus en el conjunt de dades, pel que no serà necessari realitzar cap acció al respecte. En cas de tenir valors d'aquest tipus hauriem de pensar si treure'ls o bé realitzar una aproximació del possible valor a partir de la resta de valors de la variable en qüestió.


## Valors atípics

En aquest cas, utilitzarem els diagrames de caixa per poder veure ràpidament si existeix algun valor atípic o outlier en el joc de dades, revisant totes les variables numèriques, no les categòriques:

```{r 2_2_valors_atipics_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# Calculem els diferents gràfics de caixa:
bpAge <- ggplot(data = dfHeartAttack) +
  geom_boxplot(aes(y = age, fill = "Edat")) +
  scale_fill_manual(values = "#008080") + 
  ggtitle("Boxplot per edat")

bpTRTBPS <- ggplot(data = dfHeartAttack) +
  geom_boxplot(aes(y = trtbps, fill = "Pres.")) +
  scale_fill_manual(values = "#00A595") + 
  ggtitle("Boxplot per pressió arterial en repòs")

bpChol <- ggplot(data = dfHeartAttack) +
  geom_boxplot(aes(y = chol, fill = "Col.")) +
  scale_fill_manual(values = "#00B080") + 
  ggtitle("Boxplot per nivell de colesterol")

bpOldpeak <- ggplot(data = dfHeartAttack) +
  geom_boxplot(aes(y = oldpeak, fill = "Canv.")) +
  scale_fill_manual(values = "#00C0B0") + 
  ggtitle("Boxplot per canvis en l'electrocardiograma")

bpThalachh <- ggplot(data = dfHeartAttack) +
  geom_boxplot(aes(y = thalachh, fill = "Freq.")) +
  scale_fill_manual(values = "#00D0A0") + 
  ggtitle("Boxplot per freqüència màxima registrada")

# Mostrem els diferents gràfics de forma agrupada:
grid.newpage()
grid.arrange(bpAge, bpTRTBPS, bpChol, bpOldpeak, bpThalachh, ncol=3)
```

Abans de continuar, no s'ha realitzat aquesta revisió de les variables categòriques ja que es pot comprovar en el resum estadístic que s'ha calculat inicialment que no hi ha valors fora dels vàlids. S'observen valors extrems a partir dels gràfics per algunes de les variables. No obstant, veiem que són valors que estan dintre dels paràmetres que es poden considerar com a vàlids:

* Pressió arterial per sobre de 170: tot i que estigui per sobre del normal, és un valor possible i, per tant, els mantindrem dintre del joc de dades.
* Colesterol per sobre de 400: novament ens trobem davant de valors extrems, però que es troben dins d'un rang possible, pel que mantindrem aquestes observacions dins el joc de dades a analitzar.
* Canvis en l'electrocardiograma per sobre de 4: tot i que està fora dels valors més comuns, no està tant distanciat com per considerar treure'ls de l'anàlisi.
* Freqüència màxima registrada per sota de 100: tot i que existeixi un valor més baix, aquest és un valor possible i, per tant, el mantindrem dins el joc de dades.

En resum, no s'han trobat valors anòmals que puguin considerar-se fora dels valors possibles, tot i que sí hi ha alguns valors extrems degut a les condicions físiques i/o de salut dels diferents pacients.


## Normalització

Comencem 


## Discretització

Afegirem alguns nous valors de forma que s'agrupin les observacions numèriques i ens permetin tenir altres variables categòriques que puguin resultar útils durant l'anàlisi:

```{r 2_X_categoritzacio_variables_numeriques_joc_dades, echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem la llibreria "arules" que ens permetrà realitzar la discretització de forma automàtica
if (!require("arules")) install.packages("arules"); library("arules")

# Seleccionem la llavor per l'algoritme randomitzador:
set.seed(1234)

# Discretitzem les variables numèriques, amb clústers automàtics en diferents rangs segons el tipus de dades que contenen:
dfHeartAttack$age_disc <- discretize(dfHeartAttack$age, "cluster", breaks = 5)
dfHeartAttack$trtbps_disc <- discretize(dfHeartAttack$trtbps, "cluster", breaks = 3)
dfHeartAttack$chol_disc <- discretize(dfHeartAttack$chol, "cluster", breaks = 5)
dfHeartAttack$thalachh_disc <- discretize(dfHeartAttack$thalachh, "cluster", breaks = 3)

# Mostrem els resums per comprovar que s'han realitzat les agrupacions en clústers correctament:
summary(dfHeartAttack$age_disc)
summary(dfHeartAttack$trtbps_disc)
summary(dfHeartAttack$chol_disc)
summary(dfHeartAttack$thalachh_disc)
```



# Anàlisi de les dades

## Correlació de les variables


# Representació dels resultats a partir de taules i gràfiques



# Resolució del problema


